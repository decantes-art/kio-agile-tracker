<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIO - Gestión Ágil</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/phosphor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { inter: ['Inter', 'sans-serif'] },
                    colors: {
                        'kio-cyan': '#4DCFFF', 
                        'kio-navy-darker': '#0A0A40',
                        'kio-navy-dark': '#1A1A70',
                    }
                }
            }
        }
    </script>

    <style>
        :root { --color-kio-cyan: #4DCFFF; --color-kio-navy-darker: #0A0A40; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; }
        
        /* Arreglo de la barra superior */
        .kio-app-bar-container {
            position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
            max-width: 95%; width: 100%; border-radius: 1.5rem; z-index: 100; /* Capa más alta */
            background-color: var(--color-kio-navy-darker);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        
        /* Espaciado para que nada quede debajo de la barra */
        main { padding-top: 10rem; position: relative; z-index: 10; }
        
        .kio-logo-text { color: white; text-shadow: 0 0 8px var(--color-kio-cyan); }
        .kanban-column { background: #e5e7eb; border-radius: 1.2rem; min-height: 60vh; width: 300px; flex-shrink: 0; }
        
        /* Pantalla de bloqueo de seguridad */
        #login-overlay {
            position: fixed; inset: 0; background: #0A0A40; 
            z-index: 200; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="antialiased">

    <div id="login-overlay">
        <div class="text-center">
            <h1 class="text-6xl font-black text-white mb-2 kio-logo-text">KIO</h1>
            <p class="text-kio-cyan font-bold tracking-[0.2em] mb-8">SISTEMA DE ACCESO PRIVADO</p>
            <div id="google-btn"></div>
            <p id="error-msg" class="text-red-400 text-xs mt-4 hidden">Acceso solo para dominios @kio.tech</p>
        </div>
    </div>

    <header class="kio-app-bar-container">
        <div class="px-8 h-16 sm:h-20 flex items-center relative">
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-extrabold kio-logo-text uppercase">Kio</span>
                <span class="text-[10px] text-gray-400 font-bold hidden sm:block">MADE TO DISRUPT</span>
            </div>
            <div class="flex-grow flex justify-center absolute inset-0 items-center pointer-events-none">
                <h1 class="text-white font-black tracking-widest text-lg uppercase">Gestión de Proyectos</h1>
            </div>
            <div class="ml-auto" id="user-info">
                </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-red-500">
                <p class="text-[10px] font-black text-gray-400 uppercase">Estancadas</p>
                <p class="text-3xl font-black text-gray-800" id="stale-count">0</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-kio-cyan">
                <p class="text-[10px] font-black text-gray-400 uppercase">En Curso</p>
                <p class="text-3xl font-black text-gray-800" id="progress-count">0</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-green-500">
                <p class="text-[10px] font-black text-gray-400 uppercase">Finalizadas</p>
                <p class="text-3xl font-black text-gray-800" id="done-count">0</p>
            </div>
        </div>

        <div class="flex gap-6 overflow-x-auto pb-10">
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-gray-500 mb-4 uppercase">Backlog</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="Backlog"></div></div>
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-gray-500 mb-4 uppercase">En Curso</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="In Progress"></div></div>
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-gray-500 mb-4 uppercase">Revisión</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="Review"></div></div>
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-green-600 mb-4 uppercase">Finalizado</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="Done"></div></div>
        </div>
    </main>

    <button onclick="toggleModal(true)" class="fixed bottom-8 right-8 bg-kio-navy-dark text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-all z-50 border-4 border-white">
        <i class="ph-bold ph-plus text-2xl"></i>
    </button>

    <script>
        // 1. CONFIGURACIÓN (Pon tus llaves aquí)
        const SUPABASE_URL = 'https://cmtfevqonvihtqqwwqgc.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_P7LOmUI8DJUKkIcdkDgzAg_CPOfcS4e';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. LÓGICA DE LOGIN CON GOOGLE
        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "TU_CLIENT_ID_DE_GOOGLE.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("google-btn"),
                { theme: "outline", size: "large", text: "continue_with" }
            );
        }

        function handleCredentialResponse(response) {
            const data = JSON.parse(atob(response.credential.split('.')[1]));
            if (data.email.endsWith("@kio.tech")) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('user-info').innerHTML = `<span class="text-white text-xs font-bold">${data.name}</span>`;
                cargarTareas();
            } else {
                document.getElementById('error-msg').classList.remove('hidden');
            }
        }

        // 3. CARGA DE DATOS (Mismo que antes pero optimizado)
        async function cargarTareas() {
            const { data: tareas } = await supabase.from('tareas').select('*').order('ultima_actualizacion', { ascending: false });
            if (!tareas) return;
            
            document.querySelectorAll('.kanban-content').forEach(el => el.innerHTML = '');
            tareas.forEach(t => {
                const col = document.querySelector(`[data-status="${t.estado}"]`);
                if (col) {
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-3 cursor-move hover:border-kio-cyan transition";
                    card.innerHTML = `<p class="text-sm font-bold text-gray-700">${t.titulo}</p>`;
                    col.appendChild(card);
                }
            });
            // (Aquí actualizas los contadores...)
        }

        function toggleModal(s) { /* Lógica de modal */ }
    </script>
</body>
</html>
