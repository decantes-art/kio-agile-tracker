<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIO - Seguimiento de Proyectos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/phosphor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { inter: ['Inter', 'sans-serif'] },
                    colors: {
                        'kio-cyan': '#4DCFFF', 
                        'kio-navy-darker': '#0A0A40',
                        'kio-navy-dark': '#1A1A70',
                    }
                }
            }
        }
    </script>

    <style>
        :root { --color-kio-cyan: #4DCFFF; --color-kio-navy-darker: #0A0A40; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .app-bar-bg { background-color: var(--color-kio-navy-darker); box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        .kio-app-bar-container {
            position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%);
            max-width: 90%; width: 100%; border-radius: 1.5rem; z-index: 50;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }
        .kio-logo-text { color: white; text-shadow: 0 0 5px var(--color-kio-cyan); }
        main { padding-top: 8rem; }
        .kanban-column { background: #e5e7eb; border-radius: 1.2rem; min-height: 60vh; width: 300px; flex-shrink: 0; }
    </style>
</head>
<body class="antialiased">

    <header class="kio-app-bar-container app-bar-bg">
        <div class="px-6 h-16 sm:h-20 flex items-center relative">
            <div class="flex items-center space-x-2">
                <span class="text-xl sm:text-2xl font-extrabold kio-logo-text">KIO</span>
                <span class="text-[10px] text-gray-400 font-semibold tracking-wider uppercase hidden sm:block">MADE TO DISRUPT</span>
            </div>
            <div class="flex-grow flex justify-center items-center h-full absolute inset-0 pointer-events-none">
                <h1 class="text-white font-bold tracking-wide text-sm sm:text-lg">GESTI√ìN DE PROYECTOS √ÅGILES</h1>
            </div>
            <div class="ml-auto">
                <button onclick="syncGmail()" class="text-kio-cyan border border-kio-cyan/30 px-4 py-1 rounded-full text-[10px] font-bold hover:bg-kio-cyan hover:text-kio-navy-dark transition">
                    SINCRONIZAR GMAIL
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-5 rounded-2xl shadow-sm flex items-center gap-4">
                <div class="bg-red-100 p-3 rounded-xl"><i class="ph-bold ph-warning-octagon text-red-600 text-xl"></i></div>
                <div><p class="text-[10px] font-black text-gray-400">ESTANCADAS</p><p class="text-2xl font-bold text-gray-800" id="stale-count">0</p></div>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm flex items-center gap-4 border-b-4 border-kio-cyan">
                <div class="bg-blue-100 p-3 rounded-xl"><i class="ph-bold ph-trend-up text-blue-600 text-xl"></i></div>
                <div><p class="text-[10px] font-black text-gray-400">EN CURSO</p><p class="text-2xl font-bold text-gray-800" id="progress-count">0</p></div>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm flex items-center gap-4">
                <div class="bg-green-100 p-3 rounded-xl"><i class="ph-bold ph-check-circle text-green-600 text-xl"></i></div>
                <div><p class="text-[10px] font-black text-gray-400">FINALIZADAS</p><p class="text-2xl font-bold text-gray-800" id="done-count">0</p></div>
            </div>
        </div>

        <div class="flex gap-6 overflow-x-auto pb-10">
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-gray-500 mb-4 uppercase tracking-tighter">Backlog</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="Backlog"></div></div>
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-gray-500 mb-4 uppercase tracking-tighter">En Curso</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="In Progress"></div></div>
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-gray-500 mb-4 uppercase tracking-tighter">Revisi√≥n</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="Review"></div></div>
            <div class="kanban-column p-4"><h3 class="text-xs font-black text-gray-500 mb-4 uppercase tracking-tighter text-green-600">Finalizado</h3><div class="kanban-content space-y-4 min-h-[400px]" data-status="Done"></div></div>
        </div>
    </main>

    <button onclick="toggleModal(true)" class="fixed bottom-8 right-8 bg-kio-navy-dark text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-all z-40 border-4 border-white">
        <i class="ph-bold ph-plus text-2xl"></i>
    </button>

    <div id="taskModal" class="fixed inset-0 bg-kio-navy-darker/70 backdrop-blur-md z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
            <div class="bg-kio-navy-darker p-6 flex justify-between items-center text-white">
                <h3 class="font-bold tracking-widest">NUEVA ACTIVIDAD √ÅGIL</h3>
                <button onclick="toggleModal(false)" class="opacity-50 hover:opacity-100"><i class="ph-bold ph-x"></i></button>
            </div>
            <form id="taskForm" class="p-8 space-y-5">
                <input type="text" id="taskTitle" placeholder="Nombre de la actividad" required class="w-full border-b-2 border-gray-100 py-3 outline-none focus:border-kio-cyan text-sm transition">
                <select id="taskPriority" class="w-full bg-gray-50 p-3 rounded-xl text-xs font-bold text-gray-500 outline-none">
                    <option value="Baja">PRIORIDAD BAJA</option>
                    <option value="Media" selected>PRIORIDAD MEDIA</option>
                    <option value="Alta">PRIORIDAD ALTA</option>
                    <option value="Critica">PRIORIDAD CR√çTICA üî•</option>
                </select>
                <button type="submit" class="w-full bg-kio-navy-dark text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-black transition uppercase text-xs tracking-widest">Crear en Backlog</button>
            </form>
        </div>
    </div>

    <script>
        // --- PEGA TUS DATOS AQU√ç ---
        const SUPABASE_URL = 'https://cmtfevqonvihtqqwwqgc.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_P7LOmUI8DJUKkIcdkDgzAg_CPOfcS4e';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function cargarTareas() {
            const { data: tareas, error } = await supabase.from('tareas').select('*').order('ultima_actualizacion', { ascending: false });
            if (error) return console.error(error);

            document.querySelectorAll('.kanban-content').forEach(el => el.innerHTML = '');
            
            tareas.forEach(t => {
                const col = document.querySelector(`[data-status="${t.estado}"]`);
                if (!col) return;

                const esEstancada = (new Date() - new Date(t.ultima_actualizacion)) > 172800000;
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-2xl shadow-sm border ${esEstancada ? 'border-l-4 border-red-500' : 'border-gray-100'} cursor-move relative transition hover:shadow-md`;
                card.setAttribute('data-id', t.id);
                card.innerHTML = `
                    ${esEstancada ? '<span class="absolute top-2 right-2 text-[8px] bg-red-500 text-white px-2 py-0.5 rounded-full font-bold animate-pulse">ESTANCADA</span>' : ''}
                    <p class="text-sm font-bold text-gray-700 leading-tight">${t.titulo}</p>
                    <div class="mt-4 flex justify-between items-center text-[9px] font-black text-gray-300">
                        <span class="${t.prioridad === 'Critica' ? 'text-red-400' : ''}">${t.prioridad.toUpperCase()}</span>
                        <span>${new Date(t.ultima_actualizacion).toLocaleDateString()}</span>
                    </div>
                `;
                col.appendChild(card);
            });
            actualizarMetricas(tareas);
        }

        async function actualizarEstado(id, nuevoEstado) {
            await supabase.from('tareas').update({ estado: nuevoEstado, ultima_actualizacion: new Date().toISOString() }).eq('id', id);
            cargarTareas();
        }

        function actualizarMetricas(tareas) {
            document.getElementById('stale-count').innerText = tareas.filter(t => (new Date() - new Date(t.ultima_actualizacion)) > 172800000 && t.estado !== 'Done').length;
            document.getElementById('progress-count').innerText = tareas.filter(t => t.estado === 'In Progress').length;
            document.getElementById('done-count').innerText = tareas.filter(t => t.estado === 'Done').length;
        }

        // DRAG & DROP
        document.querySelectorAll('.kanban-content').forEach(el => {
            new Sortable(el, {
                group: 'kanban',
                animation: 150,
                onEnd: (evt) => actualizarEstado(evt.item.getAttribute('data-id'), evt.to.getAttribute('data-status'))
            });
        });

        // FORMULARIO
        document.getElementById('taskForm').onsubmit = async (e) => {
            e.preventDefault();
            const titulo = document.getElementById('taskTitle').value;
            const prioridad = document.getElementById('taskPriority').value;
            await supabase.from('tareas').insert([{ titulo, prioridad, estado: 'Backlog' }]);
            toggleModal(false);
            e.target.reset();
            cargarTareas();
        };

        function toggleModal(s) { document.getElementById('taskModal').classList.toggle('hidden', !s); }
        function syncGmail() { alert("Buscando requerimientos en tu bandeja de KIO..."); }

        cargarTareas();
        
        // TIEMPO REAL
        supabase.channel('custom-all-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'tareas' }, () => cargarTareas()).subscribe();
    </script>
</body>
</html>
